%%%Sahand_tang_erami%%%
%%%Advanced_Control_II_project%%%
clear all
close all
clc
%state_variable_matrixes
A=[-3 0 -1;0 -2 1;0 1 -9];
B=[1;0;5];
C=[1 2 0];
D=[0];
%initial_value_and_noise_parameter
G=[1 0;1 0;1 0];
Q=[4 0;0 0.03];
x0=[0;.5;-1];
R=10;
m11(1)=1;
m12(1)=0;
m13(1)=0;
m22(1)=.02;
m23(1)=0;
m33(1)=.5;
M(:,:,1)=[m11(1) m12(1) m13(1);m12(1) m22(1) m23(1);m13(1) m23(1) m33(1)];
%time_difference
tf=10;
dt=.01;
t=0:dt:tf;
N=length(t);
%adams_bashforth_method
f11(1)=4-2*m13(1)-m12(1)*(m11(1)/5+(2*m12(1))/5)-m11(1)*(m11(1)/10 + m12(1)/5) - 6*m11(1);
f12(1)=m13(1)-5*m12(1)-m23(1)-m12(1)*(m11(1)/10+m12(1)/5)-m22(1)*(m11(1)/5+(2*m12(1))/5);
f13(1)=m12(1)-12*m13(1)-m33(1)-m13(1)*(m11(1)/10+m12(1)/5)-m23(1)*(m11(1)/5+(2*m12(1))/5)+4;
f22(1)=2*m23(1)-4*m22(1)-m12(1)*(m12(1)/10+m22(1)/5)-m22(1)*(m12(1)/5+(2*m22(1))/5)+3/100;
f23(1)=m22(1)-11*m23(1)+m33(1)-m13(1)*(m12(1)/10+m22(1)/5)-m23(1)*(m12(1)/5+(2*m22(1))/5);
f33(1)=2*m23(1)-18*m33(1)-m13(1)*(m13(1)/10+m23(1)/5)-m23(1)*(m13(1)/5+(2*m23(1))/5)+4;
m11(2) = m11(1) + (dt/12)*(23*f11(1));
m12(2) = m12(1) + (dt/12)*(23*f12(1));
m13(2) = m13(1) + (dt/12)*(23*f13(1));
m22(2) = m22(1) + (dt/12)*(23*f22(1));
m23(2) = m23(1) + (dt/12)*(23*f23(1));
m33(2) = m33(1) + (dt/12)*(23*f33(1));
M(:,:,2)=[m11(2) m12(2) m13(2);m12(2) m22(2) m23(2);m13(2) m23(2) m33(2)];

f11(2)=4-2*m13(2)-m12(2)*(m11(2)/5+(2*m12(2))/5)-m11(2)*(m11(2)/10 + m12(2)/5) - 6*m11(2);
f12(2)=m13(2)-5*m12(2)-m23(2)-m12(2)*(m11(2)/10+m12(2)/5)-m22(2)*(m11(2)/5+(2*m12(2))/5);
f13(2)=m12(2)-12*m13(2)-m33(2)-m13(2)*(m11(2)/10+m12(2)/5)-m23(2)*(m11(2)/5+(2*m12(2))/5)+4;
f22(2)=2*m23(2)-4*m22(2)-m12(2)*(m12(2)/10+m22(2)/5)-m22(2)*(m12(2)/5+(2*m22(2))/5)+3/100;
f23(2)=m22(2)-11*m23(2)+m33(2)-m13(2)*(m12(2)/10+m22(2)/5)-m23(2)*(m12(2)/5+(2*m22(2))/5);
f33(2)=2*m23(2)-18*m33(2)-m13(2)*(m13(2)/10+m23(2)/5)-m23(2)*(m13(2)/5+(2*m23(2))/5)+4;
m11(3) = m11(2) + (dt/12)*(23*f11(2)-16*f11(1));
m12(3) = m12(2) + (dt/12)*(23*f12(2)-16*f12(1));
m13(3) = m13(2) + (dt/12)*(23*f13(2)-16*f13(1));
m22(3) = m22(2) + (dt/12)*(23*f22(2)-16*f22(1));
m23(3) = m23(2) + (dt/12)*(23*f23(2)-16*f23(1));
m33(3) = m33(2) + (dt/12)*(23*f33(2)-16*f33(1));
M(:,:,3)=[m11(3) m12(3) m13(3);m12(3) m22(3) m23(3);m13(3) m23(3) m33(3)];

f11(3)=4-2*m13(3)-m12(3)*(m11(3)/5+(2*m12(3))/5)-m11(3)*(m11(3)/10 + m12(3)/5) - 6*m11(3);
f12(3)=m13(3)-5*m12(3)-m23(3)-m12(3)*(m11(3)/10+m12(3)/5)-m22(3)*(m11(3)/5+(2*m12(3))/5);
f13(3)=m12(3)-12*m13(3)-m33(3)-m13(3)*(m11(3)/10+m12(3)/5)-m23(3)*(m11(3)/5+(2*m12(3))/5)+4;
f22(3)=2*m23(3)-4*m22(3)-m12(3)*(m12(3)/10+m22(3)/5)-m22(3)*(m12(3)/5+(2*m22(3))/5)+3/100;
f23(3)=m22(3)-11*m23(3)+m33(3)-m13(3)*(m12(3)/10+m22(3)/5)-m23(3)*(m12(3)/5+(2*m22(3))/5);
f33(3)=2*m23(3)-18*m33(3)-m13(3)*(m13(3)/10+m23(3)/5)-m23(3)*(m13(3)/5+(2*m23(3))/5)+4;

for i = 3:length(t)-1
f11(i)=4-2*m13(i)-m12(i)*(m11(i)/5+(2*m12(i))/5)-m11(i)*(m11(i)/10 + m12(i)/5)-6*m11(i);
f12(i)=m13(i)-5*m12(i)-m23(i)-m12(i)*(m11(i)/10+m12(i)/5)-m22(i)*(m11(i)/5+(2*m12(i))/5);
f13(i)=m12(i)-12*m13(i)-m33(i)-m13(i)*(m11(i)/10+m12(i)/5)-m23(i)*(m11(i)/5+(2*m12(i))/5)+4;
f22(i)=2*m23(i)-4*m22(i)-m12(i)*(m12(i)/10+m22(i)/5)-m22(i)*(m12(i)/5+(2*m22(i))/5)+3/100;
f23(i)=m22(i)-11*m23(i)+m33(i)-m13(i)*(m12(i)/10+m22(i)/5)-m23(i)*(m12(i)/5+(2*m22(i))/5);
f33(i)=2*m23(i)-18*m33(i)-m13(i)*(m13(i)/10+m23(i)/5)-m23(i)*(m13(i)/5+(2*m23(i))/5)+4;
m11(i+1) = m11(i) + (dt/12)*(23*f11(i)-16*f11(i)+5*f11(i-2));
m12(i+1) = m12(i) + (dt/12)*(23*f12(i)-16*f12(i-1)+5*f12(i-2));
m13(i+1) = m13(i) + (dt/12)*(23*f13(i)-16*f13(i-1)+5*f13(i-2));
m22(i+1) = m22(i) + (dt/12)*(23*f22(i)-16*f22(i-1)+5*f22(i-2));
m23(i+1) = m23(i) + (dt/12)*(23*f23(i)-16*f23(i-1)+5*f23(i-2));
m33(i+1) = m33(i) + (dt/12)*(23*f33(i)-16*f33(i-1)+5*f33(i-2));
M(:,:,i)=[m11(i) m12(i) m13(i);m12(i) m22(i) m23(i);m13(i) m23(i) m33(i)];
L(:,:,i)=M(:,:,i)*C'*(1/R);
end
%plot_of_m
plot (t,m11)
hold on
plot (t,m12)
hold on
plot (t,m13)
hold on
plot (t,m22)
hold on
plot (t,m23)
hold on
plot (t,m33)
legend('M_1(t)','M_2(t)','M_3(t)','M_4(t)','M_5(t)','M_6(t)')
xlabel('time(sec)')
ylabel('Error Covariance')
title('M(t) elements')
grid on
%noise
w=mvnrnd([0;0],Q,numel(t));
v=mvnrnd(0,R,numel(t));
%euler_method
x1(1)=0;
x2(1)=.5;
x3(1)=-1;
y_wn(1)=x1(1)+2*x2(1);
x1_hat(1)=0;
x2_hat(1)=0;
x3_hat(1)=0;

for i = 1:length(t)-1
x1(i+1)=x1(i)+dt*(-3*x1(i)-x3(i)+0.2*sin(0.4*i+0.5)+w(i,1));
x2(i+1)=x2(i)+dt*(-2*x2(i)+x3(i)+w(i,2));
x3(i+1)=x3(i)+dt*(x2(i)-9*x3(i)+sin(0.4*i+0.5)+w(i,1));
y_wn(i+1)=x1(i+1)+2*x2(i+1);
end

for i=1:length(t)
  y(i)=y_wn(i)+v(i);  
end

for i = 1:length(t)-1
x1_hat(i+1)=x1_hat(i)+dt*(-3*x1_hat(i)-x3_hat(i)+0.2*sin(0.4*i+0.5)+L(1,:,i)*(y(i)-x1_hat(i)-2*x2_hat(i)));
x2_hat(i+1)=x2_hat(i)+dt*(-2*x2_hat(i)+x3_hat(i)+L(1,:,i)*(y(i)-x1_hat(i)-2*x2_hat(i)));
x3_hat(i+1)=x3_hat(i)+dt*(x2_hat(i)-9*x3_hat(i)+sin(0.4*i+0.5)+L(1,:,i)*(y(i)-x1_hat(i)-2*x2_hat(i)));
end
%State_variable_plot
figure
plot (t,x1_hat)
hold on
plot (t,x1)
legend('Xhat_{1}','x_1')
xlabel('time(sec)')
ylabel('Amplitude')
title('First State')
grid on

figure
plot (t,x2_hat)
hold on
plot (t,x2)
legend('Xhat_{2}','x_2')
xlabel('time(sec)')
ylabel('Amplitude')
title('2nd State')
grid on

figure
plot (t,x3_hat)
hold on
plot (t,x3)
legend('Xhat_{3}','x_3')
xlabel('time(sec)')
ylabel('Amplitude')
title('3rd State')
grid on